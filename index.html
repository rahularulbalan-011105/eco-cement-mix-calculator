<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoMix Carbon Comparator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Custom scrollbar styling for better aesthetics */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        body::-webkit-scrollbar-thumb {
            background: #4ade80;
            border-radius: 4px;
        }
        body::-webkit-scrollbar-thumb:hover {
            background: #22c55e;
        }
        /* Custom classes for the main grid layout */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
        }
        /* Remove custom gauge styling as it is replaced by Chart.js */
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">

    <!-- Main Container -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8 lg:p-12">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-800">EcoMix Carbon Comparator</h1>
            <p class="text-lg text-gray-500 mt-2">IS 10262:2019 Mix Design & Environmental Analysis</p>
        </header>

        <!-- Dynamic Error Message Display -->
        <div id="message-box" class="hidden p-4 mb-6 rounded-xl shadow-lg transition-all" role="alert">
            <div class="flex items-center">
                <svg id="message-icon" class="flex-shrink-0 w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                <span id="message-text" class="font-medium"></span>
            </div>
        </div>

        <div class="lg:grid lg:grid-cols-3 lg:gap-8">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-xl sticky top-8 h-fit">
                <h2 class="text-2xl font-semibold text-green-700 mb-6 border-b pb-3">Mix Design Inputs</h2>

                <form id="design-form">
                    
                    <!-- Project Inputs -->
                    <div class="mb-8">
                        <h3 class="text-xl font-medium text-gray-700 mb-4">Project Inputs</h3>
                        <div class="input-grid space-y-4 md:space-y-0">
                            <div>
                                <label for="project_volume_m3" class="block text-sm font-medium text-gray-600">Volume of Concrete (m³)</label>
                                <input type="number" id="project_volume_m3" name="project_volume_m3" value="100.0" step="0.1" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                            </div>
                            <div>
                                <label for="wastage_pct" class="block text-sm font-medium text-gray-600">Wastage Percentage (%)</label>
                                <input type="number" id="wastage_pct" name="wastage_pct" value="5.0" step="0.1" min="0" max="20" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Core Parameters -->
                    <div class="mb-8">
                        <h3 class="text-xl font-medium text-gray-700 mb-4 border-t pt-4">Core Parameters</h3>
                        
                        <div class="space-y-4">
                            <!-- Target Strength -->
                            <div>
                                <label for="fck_mpa" class="block text-sm font-medium text-gray-600">Target Strength (fck, MPa)</label>
                                <input type="number" id="fck_mpa" name="fck_mpa" value="40" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                            </div>
                            
                            <!-- W/C and Slump Grid -->
                            <div class="input-grid">
                                <div>
                                    <label for="w_c_ratio" class="block text-sm font-medium text-gray-600">Water/Cement (w/c) Ratio</label>
                                    <input type="number" id="w_c_ratio" name="w_c_ratio" value="0.36" step="0.01" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                </div>
                                <div>
                                    <label for="slump_mm" class="block text-sm font-medium text-gray-600">Slump (mm)</label>
                                    <input type="number" id="slump_mm" name="slump_mm" value="75" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                </div>
                            </div>
                            
                            <!-- Exposure Condition -->
                            <div>
                                <label for="exposure" class="block text-sm font-medium text-gray-600">Exposure Condition (IS 456)</label>
                                <select id="exposure" name="exposure" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                    <option value="mild">Mild</option>
                                    <option value="moderate">Moderate</option>
                                    <option value="severe" selected>Severe</option>
                                    <option value="very_severe">Very Severe</option>
                                    <option value="extreme">Extreme</option>
                                </select>
                            </div>

                            <!-- Placing Method -->
                            <div>
                                <label for="placing_method" class="block text-sm font-medium text-gray-600">Placing Method</label>
                                <select id="placing_method" name="placing_method" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                    <option value="manual_placing">Manual Placing</option>
                                    <option value="chute_non_pumpable" selected>Chute (Non-Pumpable)</option>
                                    <option value="pumping">Pumping</option>
                                </select>
                            </div>

                            <!-- Superplasticizer Checkbox -->
                            <div class="pt-2">
                                <label class="flex items-center text-sm font-medium text-gray-600 cursor-pointer">
                                    <input type="checkbox" id="use_superplasticizer" name="use_superplasticizer" checked class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                    <span class="ml-2">Use Superplasticizer (20% water reduction)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Material Inputs -->
                    <div class="mb-8">
                        <h3 class="text-xl font-medium text-gray-700 mb-4 border-t pt-4">Material Inputs</h3>
                        <div class="space-y-4">
                            
                            <!-- Cement Selection Grid -->
                            <div class="input-grid">
                                <div>
                                    <label for="cement_type" class="block text-sm font-medium text-gray-600">Cement Type</label>
                                    <select id="cement_type" name="cement_type" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                        <option value="OPC" selected>OPC (Ordinary Portland)</option>
                                        <option value="PPC-FLYASH">PPC (Flyash-based)</option>
                                        <option value="PPC-CALCINED">PPC (Calcined Clay-based)</option>
                                        <option value="PSC">PSC (Portland Slag)</option>
                                    </select>
                                </div>
                                
                                <div id="cement_grade_container">
                                    <label for="cement_grade" class="block text-sm font-medium text-gray-600">Cement Grade</label>
                                    <select id="cement_grade" name="cement_grade" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                        <option value="43" selected>43</option>
                                        <option value="53">53</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Max Aggregate Size -->
                            <div>
                                <label for="max_agg_size_mm" class="block text-sm font-medium text-gray-600">Max Aggregate Size (mm)</label>
                                <select id="max_agg_size_mm" name="max_agg_size_mm" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                    <option value="20" selected>20 mm</option>
                                    <option value="10">10 mm</option>
                                    <option value="12.5">12.5 mm</option>
                                    <option value="40">40 mm</option>
                                </select>
                            </div>
                            
                            <h4 class="text-lg font-medium text-gray-700 mt-6 pt-2 border-t">Specific Gravity (SG)</h4>

                            <!-- Specific Gravity Inputs -->
                            <div class="input-grid">
                                <div>
                                    <label for="sg_cement" class="block text-sm font-medium text-gray-600">Cement</label>
                                    <input type="number" id="sg_cement" name="sg_cement" value="3.15" step="0.01" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                </div>
                                <div>
                                    <label for="sg_coarse" class="block text-sm font-medium text-gray-600">Coarse Aggregate</label>
                                    <input type="number" id="sg_coarse" name="sg_coarse" value="2.70" step="0.01" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                </div>
                                <div>
                                    <label for="sg_fine" class="block text-sm font-medium text-gray-600">Fine Aggregate</label>
                                    <input type="number" id="sg_fine" name="sg_fine" value="2.65" step="0.01" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                </div>
                            </div>

                            <h4 class="text-lg font-medium text-gray-700 mt-6 pt-2 border-t">Water Absorption (%)</h4>
                            
                            <!-- Water Absorption Inputs -->
                            <div class="input-grid">
                                <div>
                                    <label for="wa_coarse" class="block text-sm font-medium text-gray-600">Coarse Aggregate</label>
                                    <input type="number" id="wa_coarse" name="wa_coarse" value="0.50" step="0.01" min="0" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                </div>
                                <div>
                                    <label for="wa_fine" class="block text-sm font-medium text-gray-600">Fine Aggregate</label>
                                    <input type="number" id="wa_fine" name="wa_fine" value="1.00" step="0.01" min="0" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- Eco-Mix Replacements -->
                    <div class="mb-8 p-4 bg-green-50 rounded-lg border border-green-200">
                        <h3 class="text-xl font-medium text-green-700 mb-3">Eco-Mix SCM Replacements (Fraction of Cementitious Mass)</h3>
                        <p class="text-xs text-gray-500 mb-4">Total fraction should not exceed 0.9 (90%).</p>

                        <!-- SCM Specific Gravity Header -->
                        <h4 class="text-sm font-semibold text-gray-600 mb-2">SCM Specific Gravity (SG)</h4>
                        <div id="scm_sg_container" class="grid lg:grid-cols-2 gap-4 mb-4">
                            <!-- Dynamic SCM SG inputs will be appended here -->
                            <div class="lg:col-span-2 text-sm text-gray-500" id="scm_sg_placeholder">Enter SCM fractions > 0 below to set their Specific Gravity.</div>
                        </div>

                        <!-- Two-Column Grid for SCM Fractions -->
                        <h4 class="text-sm font-semibold text-gray-600 mb-2 mt-4 pt-2 border-t">Replacement Fractions</h4>
                        <div class="grid lg:grid-cols-2 gap-4">
                            <!-- Column 1: Industrial Wastes -->
                            <div>
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Industrial Wastes</h4>
                                <div class="space-y-4">
                                    <!-- GGBS -->
                                    <div class="scm-input" data-scm-key="ggbs">
                                        <label for="ggbs_frac" class="block text-sm font-medium text-gray-600">GGBS Fraction (Max 0.9)</label>
                                        <input type="number" id="ggbs_frac" name="ggbs_frac" value="0.4" step="0.01" min="0" max="0.9" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                    </div>

                                    <!-- Flyash -->
                                    <div class="scm-input" data-scm-key="flyash">
                                        <label for="flyash_frac" class="block text-sm font-medium text-gray-600">Flyash Fraction (Max 0.6)</label>
                                        <input type="number" id="flyash_frac" name="flyash_frac" value="0.0" step="0.01" min="0" max="0.6" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                    </div>

                                    <!-- Metakaolin -->
                                    <div class="scm-input" data-scm-key="metakaolin">
                                        <label for="metakaolin_frac" class="block text-sm font-medium text-gray-600">Metakaolin Fraction (Max 0.1)</label>
                                        <input type="number" id="metakaolin_frac" name="metakaolin_frac" value="0.0" step="0.01" min="0" max="0.1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                    </div>
                                    
                                    <!-- Silica Fume -->
                                    <div class="scm-input" data-scm-key="silicafume">
                                        <label for="silica_fume_frac" class="block text-sm font-medium text-gray-600">Silica Fume Fraction (Max 0.15)</label>
                                        <input type="number" id="silica_fume_frac" name="silica_fume_frac" value="0.0" step="0.01" min="0" max="0.15" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                    </div>
                                </div>
                            </div>

                            <!-- Column 2: Agricultural Wastes -->
                            <div>
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Agricultural Wastes</h4>
                                <div class="space-y-4">
                                    <!-- RHA -->
                                    <div class="scm-input" data-scm-key="rha">
                                        <label for="rice_husk_ash_frac" class="block text-sm font-medium text-gray-600">Rice Husk Ash (RHA) Fraction (Max 0.3)</label>
                                        <input type="number" id="rice_husk_ash_frac" name="rice_husk_ash_frac" value="0.0" step="0.01" min="0" max="0.3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                    </div>
                                    
                                    <!-- Sugarcane Ash -->
                                    <div class="scm-input" data-scm-key="sugarcane_ash">
                                        <label for="sugarcane_ash_frac" class="block text-sm font-medium text-gray-600">Sugarcane Ash Fraction (Max 0.2)</label>
                                        <input type="number" id="sugarcane_ash_frac" name="sugarcane_ash_frac" value="0.0" step="0.01" min="0" max="0.2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-xl hover:bg-green-700 transition duration-150 shadow-lg shadow-green-200/50 flex items-center justify-center" id="compare-button">
                        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Compare Mixes
                    </button>
                </form>
            </div>

            <!-- Right Column: Results Dashboard -->
            <div class="lg:col-span-2 mt-8 lg:mt-0">
                
                <!-- Summary Dashboard -->
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div id="co2-card" class="p-5 bg-white rounded-2xl shadow-xl text-center border-b-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">CO₂ Reduction %</p>
                        <p id="co2_reduction_pct" class="text-3xl font-bold text-green-600 mt-1">0.00%</p>
                    </div>
                    <div id="cement-card" class="p-5 bg-white rounded-2xl shadow-xl text-center border-b-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Cement Saving %</p>
                        <p id="cement_saving_pct" class="text-3xl font-bold text-blue-600 mt-1">0.00%</p>
                    </div>
                    <div id="strength-card" class="p-5 bg-white rounded-2xl shadow-xl text-center border-b-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-500">Strength Difference (MPa)</p>
                        <p id="strength_diff_MPa" class="text-3xl font-bold text-yellow-600 mt-1">0.00</p>
                    </div>
                </div>

                <!-- Detailed Comparison Table -->
                <div id="results-container" class="bg-white p-6 rounded-2xl shadow-xl hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">Detailed Mix Comparison (Per 1 m³)</h2>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">METRIC</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">STANDARD MIX</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ECO MIX</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                
                                <!-- Performance Header -->
                                <tr>
                                    <td colspan="3" class="px-6 py-2 text-sm font-bold text-gray-700 bg-gray-100 uppercase tracking-wider">Predicted Performance Metrics</td>
                                </tr>
                                
                                <!-- Mix Ratio -->
                                <tr class="hover:bg-blue-50/50 font-bold text-blue-700">
                                    <td class="px-6 py-3 text-sm font-medium">Mix Ratio (C:FA:CA)</td>
                                    <td id="std_mix_ratio" class="px-6 py-3 text-sm text-right"></td>
                                    <td id="eco_mix_ratio" class="px-6 py-3 text-sm text-right"></td>
                                </tr>

                                <!-- Predicted Strength -->
                                <tr class="hover:bg-green-50/50">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Predicted 28D Strength (MPa)</td>
                                    <td id="std_strength" class="px-6 py-3 text-sm text-right font-semibold text-gray-700"></td>
                                    <td id="eco_strength" class="px-6 py-3 text-sm text-right font-semibold text-green-600"></td>
                                </tr>

                                <!-- Estimated CO2 Emissions -->
                                <tr class="hover:bg-red-50/50">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Estimated CO₂ Emissions (kg/m³)</td>
                                    <td id="std_co2" class="px-6 py-3 text-sm text-right font-semibold text-gray-700"></td>
                                    <td id="eco_co2" class="px-6 py-3 text-sm text-right font-semibold text-red-600"></td>
                                </tr>
                                
                                <!-- Workability Class -->
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Workability Class</td>
                                    <td id="std_workability" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="eco_workability" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                </tr>

                                <!-- Durability Index -->
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Durability Index (0-100)</td>
                                    <td id="std_durability" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="eco_durability" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                </tr>

                                <!-- Mix Masses Header -->
                                <tr>
                                    <td colspan="3" class="px-6 py-2 text-sm font-bold text-gray-700 bg-gray-100 uppercase tracking-wider">Mix Masses (kg/m³)</td>
                                </tr>

                                <!-- Cement (Actual OPC) -->
                                <tr class="hover:bg-yellow-50/50">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Cement (Actual OPC Component)</td>
                                    <td id="std_cement" class="px-6 py-3 text-sm text-right font-medium text-gray-700"></td>
                                    <td id="eco_cement" class="px-6 py-3 text-sm text-right font-medium text-gray-700"></td>
                                </tr>
                                
                                <!-- Water -->
                                <tr>
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Water</td>
                                    <td id="std_water" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="eco_water" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                </tr>
                                
                                <!-- Fine Aggregate -->
                                <tr>
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Fine Aggregate (Sand)</td>
                                    <td id="std_fine_agg" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="eco_fine_agg" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                </tr>

                                <!-- Coarse Aggregate -->
                                <tr>
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Coarse Aggregate</td>
                                    <td id="std_coarse_agg" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="eco_coarse_agg" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                </tr>

                                <!-- SCMs (Dynamic Rows) -->
                                <tr id="row_ggbs" class="hover:bg-gray-50 hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">GGBS</td>
                                    <td id="std_ggbs" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="eco_ggbs" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>
                                <tr id="row_flyash" class="hover:bg-gray-50 hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Flyash</td>
                                    <td id="std_flyash" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="eco_flyash" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>
                                <tr id="row_metakaolin" class="hover:bg-gray-50 hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Metakaolin</td>
                                    <td id="std_metakaolin" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="eco_metakaolin" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>
                                <tr id="row_silicafume" class="hover:bg-gray-50 hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Silica Fume</td>
                                    <td id="std_silicafume" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="eco_silicafume" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>
                                <tr id="row_rha" class="hover:bg-gray-50 hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Rice Husk Ash (RHA)</td>
                                    <td id="std_rha" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="eco_rha" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>
                                <tr id="row_sugarcane_ash" class="hover:bg-gray-50 hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Sugarcane Ash</td>
                                    <td id="std_sugarcane_ash" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="eco_sugarcane_ash" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>
                                
                                <!-- Project Quantities Header -->
                                <tr>
                                    <td colspan="3" class="px-6 py-2 text-sm font-bold text-gray-700 bg-gray-100 uppercase tracking-wider">Project Material Requirements (kg)</td>
                                </tr>

                                <!-- Project Material Rows (Dynamically populated by JS) -->
                                <tr id="project_row_cement" class="hover:bg-yellow-50/50">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Cement (Total)</td>
                                    <td id="proj_cement_std" class="px-6 py-3 text-sm text-right font-medium text-gray-700"></td>
                                    <td id="proj_cement_eco" class="px-6 py-3 text-sm text-right font-medium text-gray-700"></td>
                                </tr>
                                <tr id="project_row_water">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Water (Total)</td>
                                    <td id="proj_water_std" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="proj_water_eco" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                </tr>
                                <tr id="project_row_fine_agg">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Fine Aggregate (Total)</td>
                                    <td id="proj_fine_agg_std" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="proj_fine_agg_eco" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                </tr>
                                <tr id="project_row_coarse_agg">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Coarse Aggregate (Total)</td>
                                    <td id="proj_coarse_agg_std" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="proj_coarse_agg_eco" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                </tr>
                                
                                <tr id="project_row_ggbs" class="hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">GGBS (Total)</td>
                                    <td id="proj_ggbs_std" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="proj_ggbs_eco" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>
                                <tr id="project_row_flyash" class="hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Flyash (Total)</td>
                                    <td id="proj_flyash_std" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="proj_flyash_eco" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>
                                <tr id="project_row_metakaolin" class="hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Metakaolin (Total)</td>
                                    <td id="proj_metakaolin_std" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="proj_metakaolin_eco" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>
                                <tr id="project_row_silicafume" class="hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Silica Fume (Total)</td>
                                    <td id="proj_silicafume_std" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="proj_silicafume_eco" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>
                                <tr id="project_row_rha" class="hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Rice Husk Ash (RHA) (Total)</td>
                                    <td id="proj_rha_std" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="proj_rha_eco" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>
                                <tr id="project_row_sugarcane_ash" class="hidden">
                                    <td class="px-6 py-3 text-sm font-medium text-gray-900">Sugarcane Ash (Total)</td>
                                    <td id="proj_sugarcane_ash_std" class="px-6 py-3 text-sm text-right text-gray-700"></td>
                                    <td id="proj_sugarcane_ash_eco" class="px-6 py-3 text-sm text-right text-green-700"></td>
                                </tr>

                            </tbody>
                        </table>
                    </div>

                    <!-- Plot Container -->
                    <div class="grid md:grid-cols-2 gap-6 mt-8">
                        <!-- Strength Curve Plot -->
                        <div class="p-4 border rounded-2xl shadow-xl bg-white">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">Simulated Strength vs. Replacement %</h3>
                            <canvas id="strengthCurveChart"></canvas>
                        </div>
                        
                        <!-- CO2 Emission Plot -->
                        <div class="p-4 border rounded-2xl shadow-xl bg-white">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">CO₂ Emissions Comparison (kg/m³)</h3>
                            <canvas id="co2ComparisonChart"></canvas>
                        </div>
                    </div>

                    <!-- Gauge Meter Row (Centered) -->
                    <div class="flex justify-center mt-6">
                        <div class="p-4 border rounded-2xl shadow-xl bg-white text-center flex flex-col items-center w-full max-w-sm">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">Eco-Friendliness Score</h3>
                            <div class="gauge-container">
                                <div class="gauge-meter"></div>
                                <div class="gauge-center-dot"></div>
                                <div id="gauge-needle" class="gauge-needle" style="transform: rotate(180deg);"></div>
                                <p id="gauge-score-value" class="gauge-value text-3xl text-gray-800">0%</p>
                            </div>
                            <p id="gauge-label" class="mt-8 text-lg font-medium text-gray-600">Neutral</p>
                        </div>
                    </div>
                </div>
                
                <!-- Warnings Section -->
                <div id="warnings-container" class="mt-8 bg-yellow-50 p-5 rounded-2xl shadow-xl border border-yellow-300 hidden">
                    <h3 class="text-lg font-semibold text-yellow-800 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.543 2.658-1.543 3.423 0L14.4 7.636l.894 1.788c.765 1.543-.362 3.256-1.923 3.256H6.629c-1.56 0-2.688-1.713-1.923-3.256l.894-1.788L8.257 3.099z" clip-rule="evenodd"></path></svg>
                        Durability & Compliance Warnings
                    </h3>
                    <ul id="warnings-list" class="list-disc pl-5 space-y-2 text-sm text-yellow-700">
                        <!-- Warnings dynamically inserted here -->
                    </ul>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Global chart instances
        let strengthCurveChartInstance = null;
        let co2ChartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('design-form');
            const messageBox = document.getElementById('message-box');
            const compareButton = document.getElementById('compare-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const cementTypeSelect = document.getElementById('cement_type');
            const cementGradeContainer = document.getElementById('cement_grade_container');
            const scmInputContainer = document.getElementById('scm_sg_container');
            const scmFractionInputs = document.querySelectorAll('.scm-input input[type="number"]');
            const scmSgPlaceholder = document.getElementById('scm_sg_placeholder');

            // API_BASE_URL is hardcoded to ensure connection to local running server
            const API_BASE_URL = 'http://127.0.0.1:8000/api/design/compare';
            const STRENGTH_CURVE_API = 'http://127.0.0.1:8000/api/plot/strength_curve';

            // Default SCM Specific Gravities (used if user doesn't specify)
            const DEFAULT_SCM_SG = {
                'ggbs': 2.90,
                'flyash': 2.30,
                'metakaolin': 2.50,
                'silicafume': 2.20,
                'rha': 2.10,
                'sugarcane_ash': 2.00,
            };

            // --- Chart & Gauge Functions ---

            const renderGaugeMeter = (score) => {
                const needle = document.getElementById('gauge-needle');
                const scoreValueEl = document.getElementById('gauge-score-value');
                const labelEl = document.getElementById('gauge-label');
                
                // Score 0 maps to 180deg (left/red), Score 100 maps to 0deg (right/green).
                // Formula: angle = 180 - (score * 1.8)
                const angle = 180 - (score * 1.8); 
                needle.style.transform = `rotate(${angle}deg)`;
                scoreValueEl.textContent = `${score.toFixed(0)}%`;

                let label, color;
                if (score < 40) {
                    label = 'Low Eco Benefit';
                    color = '#dc2626'; // Red-600
                } else if (score < 65) {
                    label = 'Moderate Eco Benefit';
                    color = '#fb923c'; // Orange-500
                } else {
                    label = 'High Eco Benefit';
                    color = '#10b981'; // Emerald-600
                }

                labelEl.textContent = label;
                labelEl.style.color = color;
            };

            const renderCO2ComparisonChart = (data) => {
                if (co2ChartInstance) co2ChartInstance.destroy();
                
                const co2Data = [
                    data.standard.co2.co2_eco_kg_per_m3,
                    data.eco.co2.co2_eco_kg_per_m3
                ];
                
                const ctx = document.getElementById('co2ComparisonChart').getContext('2d');
                co2ChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Standard Mix', 'Eco Mix'],
                        datasets: [{
                            label: 'CO₂ Emissions (kg/m³)',
                            data: co2Data,
                            backgroundColor: ['#9ca3af', '#10b981'], // Gray for Std, Green for Eco
                            borderRadius: 6,
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'kg CO₂ per m³'
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { mode: 'index' }
                        }
                    }
                });
            };

            const renderStrengthCurve = async (payload) => {
                if (window.strengthCurveChartInstance) window.strengthCurveChartInstance.destroy();
                
                try {
                    const response = await fetch(STRENGTH_CURVE_API, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) throw new Error("Failed to fetch strength simulation curve.");

                    const plotData = await response.json();
                    
                    const labels = plotData.map(p => `${p.replacement_pct.toFixed(0)}%`);
                    const strengthData = plotData.map(p => p.predicted_strength_mpa);
                    const isTarget = plotData[0].is_target_strength; 

                    const ctx = document.getElementById('strengthCurveChart').getContext('2d');

                    window.strengthCurveChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Predicted 28D Strength (MPa)',
                                    data: strengthData,
                                    borderColor: '#059669', // Emerald
                                    borderWidth: 3,
                                    fill: false,
                                    tension: 0.3,
                                },
                                {
                                    label: 'Required Target Strength',
                                    data: Array(labels.length).fill(isTarget),
                                    borderColor: '#ef4444', // Red (Danger)
                                    borderWidth: 1.5,
                                    borderDash: [5, 5],
                                    fill: false,
                                    pointRadius: 0
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: {
                                    title: { display: true, text: 'SCM Replacement Percentage' }
                                },
                                y: {
                                    beginAtZero: false,
                                    title: { display: true, text: 'Strength (MPa)' }
                                }
                            },
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: { mode: 'index', intersect: false }
                            }
                        }
                    });

                } catch (e) {
                    console.error("Error drawing strength curve:", e);
                }
            };


            // --- Standard UI Functions ---

            const updateCementGradeVisibility = () => {
                const selectedType = cementTypeSelect.value;
                if (selectedType === 'OPC') {
                    cementGradeContainer.style.display = 'block';
                    document.getElementById('cement_grade').setAttribute('required', 'required');
                } else {
                    cementGradeContainer.style.display = 'none';
                    document.getElementById('cement_grade').removeAttribute('required');
                }
            };

            const generateScmSgInputs = () => {
                const activeScms = [];
                scmFractionInputs.forEach(input => {
                    const frac = parseFloat(input.value);
                    if (frac > 0) {
                        const key = input.closest('.scm-input').getAttribute('data-scm-key');
                        activeScms.push(key);
                    }
                });

                scmInputContainer.innerHTML = '';

                if (activeScms.length === 0) {
                    scmInputContainer.appendChild(scmSgPlaceholder);
                    return;
                }

                activeScms.forEach(key => {
                    const labelText = key.replace(/([A-Z])/g, ' $1').toUpperCase();
                    const defaultValue = DEFAULT_SCM_SG[key] || 2.70;

                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label for="sg_${key}" class="block text-sm font-medium text-gray-600">${labelText} (SG)</label>
                        <input type="number" id="sg_${key}" name="sg_${key}" value="${defaultValue}" step="0.01" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring focus:ring-green-500 focus:ring-opacity-50">
                    `;
                    scmInputContainer.appendChild(div);
                });
                scmInputContainer.style.gridTemplateColumns = activeScms.length > 1 ? 'repeat(2, minmax(150px, 1fr))' : '1fr';
            };

            const showMessage = (type, message) => {
                const messageIcon = document.getElementById('message-icon');
                const messageText = document.getElementById('message-text');

                messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100');
                messageBox.classList.add(type === 'error' ? 'bg-red-100' : 'bg-green-100');
                
                messageIcon.innerHTML = type === 'error' 
                    ? `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>`
                    : `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>`;
            
                messageText.textContent = message;
            };
            
            const setComparisonMetrics = (comparison) => {
                document.getElementById('co2_reduction_pct').textContent = `${comparison.co2_reduction_pct.toFixed(2)}%`;
                document.getElementById('cement_saving_pct').textContent = `${comparison.cement_saving_pct.toFixed(2)}%`;
                document.getElementById('strength_diff_MPa').textContent = `${comparison.predicted_strength_diff_MPa.toFixed(2)}`;
            };

            const formatValue = (value) => value !== null && value !== undefined ? value.toFixed(2) : '0.00';

            const renderProjectRow = (elementId, stdValue, ecoValue) => {
                const stdEl = document.getElementById('proj_' + elementId + '_std');
                const ecoEl = document.getElementById('proj_' + elementId + '_eco');
                const rowEl = document.getElementById('project_row_' + elementId);

                if (stdEl && ecoEl) {
                    stdEl.textContent = formatValue(stdValue) + ' kg';
                    ecoEl.textContent = formatValue(ecoValue) + ' kg';
                }
                if (rowEl) {
                    if (stdValue > 0.1 || ecoValue > 0.1) {
                        rowEl.classList.remove('hidden');
                    } else {
                        rowEl.classList.add('hidden');
                    }
                }
            };
            

            const renderResults = (data) => {
                const scmMap = {
                    'ggbs': ['GGBS', 'row_ggbs', 'std_ggbs', 'eco_ggbs'],
                    'flyash': ['Flyash', 'row_flyash', 'std_flyash', 'eco_flyash'],
                    'metakaolin': ['Metakaolin', 'row_metakaolin', 'std_metakaolin', 'eco_metakaolin'],
                    'silicafume': ['Silica Fume', 'row_silicafume', 'std_silicafume', 'eco_silicafume'],
                    'rha': ['Rice Husk Ash (RHA)', 'row_rha', 'std_rha', 'eco_rha'],
                    'sugarcane_ash': ['Sugarcane Ash', 'row_sugarcane_ash', 'std_sugarcane_ash', 'eco_sugarcane_ash'],
                };
                
                // --- 1. Update Summary Dashboard ---
                setComparisonMetrics(data.comparison);

                // --- 2. Update Performance Metrics (Per 1 m³) ---
                document.getElementById('std_mix_ratio').textContent = data.standard.predictions.mix_ratio;
                document.getElementById('eco_mix_ratio').textContent = data.eco.predictions.mix_ratio;
                document.getElementById('std_strength').textContent = formatValue(data.standard.predictions.predicted_28d_strength_MPa) + ' MPa';
                document.getElementById('eco_strength').textContent = formatValue(data.eco.predictions.predicted_28d_strength_MPa) + ' MPa';
                document.getElementById('std_co2').textContent = formatValue(data.standard.co2.co2_eco_kg_per_m3) + ' kg/m³';
                document.getElementById('eco_co2').textContent = formatValue(data.eco.co2.co2_eco_kg_per_m3) + ' kg/m³';
                document.getElementById('std_workability').textContent = data.standard.predictions.workability_class;
                document.getElementById('eco_workability').textContent = data.eco.predictions.workability_class;
                document.getElementById('std_durability').textContent = formatValue(data.standard.predictions.durability_index_0_100);
                document.getElementById('eco_durability').textContent = formatValue(data.eco.predictions.durability_index_0_100);

                // --- 3. Update Mix Masses (Per 1 m³) ---
                document.getElementById('std_cement').textContent = formatValue(data.standard.mix_masses_kg_per_m3.cement_actual) + ' kg';
                document.getElementById('eco_cement').textContent = formatValue(data.eco.mix_masses_kg_per_m3.cement_actual) + ' kg';
                document.getElementById('std_water').textContent = formatValue(data.standard.mix_masses_kg_per_m3.water) + ' kg';
                document.getElementById('eco_water').textContent = formatValue(data.eco.mix_masses_kg_per_m3.water) + ' kg';
                document.getElementById('std_fine_agg').textContent = formatValue(data.standard.mix_masses_kg_per_m3.fine_aggregate) + ' kg';
                document.getElementById('eco_fine_agg').textContent = formatValue(data.eco.mix_masses_kg_per_m3.fine_aggregate) + ' kg';
                document.getElementById('std_coarse_agg').textContent = formatValue(data.standard.mix_masses_kg_per_m3.coarse_aggregate) + ' kg';
                document.getElementById('eco_coarse_agg').textContent = formatValue(data.eco.mix_masses_kg_per_m3.coarse_aggregate) + ' kg';

                // --- 4. Update Mix Masses (SCMs per 1 m³) ---
                Object.keys(scmMap).forEach(key => {
                    const [scmName, rowId, stdId, ecoId] = scmMap[key];
                    const row = document.getElementById(rowId);
                    
                    const stdValue = data.standard.mix_masses_kg_per_m3[key] || 0.00;
                    document.getElementById(stdId).textContent = formatValue(stdValue) + ' kg';

                    const ecoValue = data.eco.mix_masses_kg_per_m3[key] || 0.00;
                    document.getElementById(ecoId).textContent = formatValue(ecoValue) + ' kg';

                    if (stdValue > 0.01 || ecoValue > 0.01) {
                        row.classList.remove('hidden');
                    } else {
                        row.classList.add('hidden');
                    }
                });
                
                // --- 5. Update Project Requirements (Total KG) ---
                const stdProj = data.standard.required_project_quantities;
                const ecoProj = data.eco.required_project_quantities;
                
                // Static Materials
                renderProjectRow('cement', stdProj.cement_actual, ecoProj.cement_actual);
                renderProjectRow('water', stdProj.water, ecoProj.water);
                renderProjectRow('fine_agg', stdProj.fine_aggregate, ecoProj.fine_aggregate);
                renderProjectRow('coarse_agg', stdProj.coarse_aggregate, ecoProj.coarse_aggregate);
                
                // SCM Materials
                Object.keys(scmMap).forEach(key => {
                    renderProjectRow(key, 
                        stdProj[key] || 0,
                        ecoProj[key] || 0
                    );
                });


                // --- 6. Handle Warnings ---
                const warningsContainer = document.getElementById('warnings-container');
                const warningsList = document.getElementById('warnings-list');
                const allWarnings = data.standard.is_compliance.warnings.concat(data.eco.is_compliance.warnings);

                warningsList.innerHTML = '';
                if (allWarnings.length > 0) {
                    allWarnings.forEach(w => {
                        const li = document.createElement('li');
                        li.textContent = w;
                        warningsList.appendChild(li);
                    });
                    warningsContainer.classList.remove('hidden');
                } else {
                    warningsContainer.classList.add('hidden');
                }

                // --- 7. Render Charts & Gauge ---
                renderGaugeMeter(data.eco.predictions.eco_friendliness_score);
                renderCO2ComparisonChart(data);
                
                // Prepare payload for strength curve simulation
                const strengthCurvePayload = {
                    fck_mpa: data.eco.inputs.fck_mpa,
                    cement_type: data.eco.inputs.cement_type,
                    cement_grade: data.eco.inputs.cement_grade,
                    w_c_ratio: data.eco.inputs.w_c_ratio,
                    // Pass current SCM SGs for accurate volume/w/c simulation logic
                    replacements: data.eco.inputs.scm_sg 
                };
                renderStrengthCurve(strengthCurvePayload);

                document.getElementById('results-container').classList.remove('hidden');
            };

            // --- Form Submission Handler ---

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                showMessage('info', 'Calculating mix designs...');

                const formData = new FormData(form);
                const standardCementType = formData.get('cement_type');
                const standardCementGrade = standardCementType === 'OPC' ? parseInt(formData.get('cement_grade')) : 0;
                const placingMethod = formData.get('placing_method');
                
                // Collect SCM Specific Gravities dynamically
                const ecoSgData = {};
                scmInputContainer.querySelectorAll('input[type="number"]').forEach(input => {
                    const key = input.name.replace('sg_', '');
                    ecoSgData[key] = parseFloat(input.value);
                });


                const payload = {
                    standard: {
                        project_volume_m3: parseFloat(formData.get('project_volume_m3')),
                        wastage_pct: parseFloat(formData.get('wastage_pct')),
                        fck_mpa: parseFloat(formData.get('fck_mpa')),
                        w_c_ratio: parseFloat(formData.get('w_c_ratio')),
                        slump_mm: parseFloat(formData.get('slump_mm')),
                        exposure: formData.get('exposure'),
                        max_agg_size_mm: parseInt(formData.get('max_agg_size_mm')),
                        use_superplasticizer: formData.get('use_superplasticizer') === 'on',
                        cement_type: standardCementType,
                        cement_grade: standardCementGrade,
                        placing_method: placingMethod,
                        
                        // Material properties (SG and WA)
                        sg_cement: parseFloat(formData.get('sg_cement')),
                        sg_coarse: parseFloat(formData.get('sg_coarse')),
                        sg_fine: parseFloat(formData.get('sg_fine')),
                        wa_coarse: parseFloat(formData.get('wa_coarse')),
                        wa_fine: parseFloat(formData.get('wa_fine')),
                    },
                    eco: {
                        project_volume_m3: parseFloat(formData.get('project_volume_m3')),
                        wastage_pct: parseFloat(formData.get('wastage_pct')),
                        fck_mpa: parseFloat(formData.get('fck_mpa')),
                        w_c_ratio: parseFloat(formData.get('w_c_ratio')),
                        slump_mm: parseFloat(formData.get('slump_mm')),
                        exposure: formData.get('exposure'),
                        max_agg_size_mm: parseInt(formData.get('max_agg_size_mm')),
                        use_superplasticizer: formData.get('use_superplasticizer') === 'on',
                        cement_type: standardCementType,
                        cement_grade: standardCementGrade,
                        placing_method: placingMethod,
                        
                        // Material properties (SG and WA)
                        sg_cement: parseFloat(formData.get('sg_cement')),
                        sg_coarse: parseFloat(formData.get('sg_coarse')),
                        sg_fine: parseFloat(formData.get('sg_fine')),
                        wa_coarse: parseFloat(formData.get('wa_coarse')),
                        wa_fine: parseFloat(formData.get('wa_fine')),
                        
                        // Eco Mix SCMs and their dynamic SGs
                        ggbs_frac: parseFloat(formData.get('ggbs_frac') || 0.0),
                        flyash_frac: parseFloat(formData.get('flyash_frac') || 0.0),
                        silica_fume_frac: parseFloat(formData.get('silica_fume_frac') || 0.0),
                        rice_husk_ash_frac: parseFloat(formData.get('rice_husk_ash_frac') || 0.0),
                        metakaolin_frac: parseFloat(formData.get('metakaolin_frac') || 0.0),
                        sugarcane_ash_frac: parseFloat(formData.get('sugarcane_ash_frac') || 0.0),
                        
                        // Pass dynamic SCM SGs
                        scm_sg: ecoSgData
                    }
                };
                
                // If any SCM specific gravity data is missing for active SCMs, show error
                let missingSg = false;
                if (payload.eco.scm_sg) {
                    for (const key of Object.keys(payload.eco.scm_sg)) {
                         // Check if the corresponding fraction is > 0 and SG value is missing or 0
                        const fracField = `${key}_frac`;
                        if (payload.eco[fracField] > 0 && (!payload.eco.scm_sg[key] || payload.eco.scm_sg[key] <= 0)) {
                             missingSg = true;
                             break;
                        }
                    }
                }

                if (missingSg) {
                    showMessage('error', 'Please enter Specific Gravity for all active SCMs.');
                    loadingSpinner.classList.add('hidden');
                    compareButton.disabled = false;
                    return;
                }

                try {
                    const response = await fetch(API_BASE_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `HTTP error! Status: ${response.status}`);
                    }

                    const data = await response.json();
                    renderResults(data);
                    showMessage('success', 'Mix design comparison successful!');

                } catch (error) {
                    console.error('Design Error:', error);
                    showMessage('error', `Design Error: ${error.message}`);
                    document.getElementById('results-container').classList.add('hidden');
                    document.getElementById('warnings-container').classList.add('hidden');
                    
                    // Destroy charts on error
                    if (window.strengthCurveChartInstance) window.strengthCurveChartInstance.destroy();
                    if (co2ChartInstance) co2ChartInstance.destroy();
                    renderGaugeMeter(0); // Reset gauge on error
                } finally {
                    loadingSpinner.classList.add('hidden');
                    compareButton.disabled = false;
                }
            });

            // --- Initial Setup and Listeners ---
            cementTypeSelect.addEventListener('change', updateCementGradeVisibility);
            updateCementGradeVisibility();
            
            // Listen to SCM fraction changes to update SG inputs
            scmFractionInputs.forEach(input => {
                input.addEventListener('input', generateScmSgInputs);
            });
            generateScmSgInputs();
            
            // Initial Gauge Render
            renderGaugeMeter(0);
        });
    </script>
</body>
</html>